<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
    <style>
        table {
            border: 1px solid black;
            text-align: center;
            margin: 20px;
            height: 500px;
        }

        th {
            padding: 20px 20px;
            border-spacing: 10px;
        }

        td {
            column-width: 100px;
            padding: 15px 15px 20px;
        }

        .row {
            padding: 10px;
            display: inline-block;
            float: left;
        }

        canvas {
            border: 1px solid black;
            margin: 20px;
            width: 1000px !important;
            height: 500px !important;
        }

    </style>
</head>
<body>

<div style="clear: both"></div>

<div class="row">
    <table style="float: left">
        <tr>
            <th colspan="2">Sensor 1</th>
        </tr>
        <tr>
            <td>Temperature</td>
            <td>Humidity</td>
        </tr>
        <tr>
            <td id="dummy-temp-1/temperature">-</td>
            <td id="dummy-temp-1/humidity">-</td>
        </tr>
    </table>
    <canvas id="dummy-temp-1/graph"></canvas>
</div>

<div style="clear: both"></div>

<div class="row">
    <table style="float: left;">
        <tr>
            <th colspan="2">Sensor 2</th>
        </tr>
        <tr>
            <td>Temperature</td>
            <td>Humidity</td>
        </tr>
        <tr>
            <td id="dummy-temp-2/temperature">-</td>
            <td id="dummy-temp-2/humidity">-</td>
        </tr>
    </table>
    <canvas id="dummy-temp-2/graph"></canvas>
</div>

<div style="clear: both"></div>

<div class="row">
    <table style="float: left">
        <tr>
            <th colspan="2">Sensor 3</th>
        </tr>
        <tr>
            <td>Temperature</td>
            <td>Humidity</td>
        </tr>
        <tr>
            <td id="dummy-temp-3/temperature">-</td>
            <td id="dummy-temp-3/humidity">-</td>
        </tr>
    </table>
    <canvas id="dummy-temp-3/graph"></canvas>
</div>

<div style="clear: both"></div>


</body>


<script>
    function getTime(time) {
        return new Date(time).toLocaleTimeString()
    }
    window.onload = () => {
        let sensors = {}
        const socket = io();
        socket.on('init', (msg) => {
            const device = msg.device;
            const data = msg.plotdata;
            sensors[device] = {
                temperature: document.getElementById(`${device}/temperature`),
                humidity: document.getElementById(`${device}/humidity`),
                chart: new Chart(document.getElementById(`${device}/graph`).getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: data.map(d => getTime(d.time)),
                        datasets: [
                            {
                                label: 'Temperature',
                                data: data.map(d => d.temperature.toFixed(2)),
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)'
                            }, {
                                label: 'Humidity',
                                data: data.map(d => d.humidity.toFixed(2)),
                                borderColor: 'rgba(192, 192, 192, 1)',
                                backgroundColor: 'rgba(192, 192, 192, 0.2)'
                            },
                        ]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            }]
                        }
                    }
                })
            };
        });

        socket.on('realtime', (msg) => {
            sensors[msg.sensor].temperature.innerText = msg.temperature.toFixed(2);
            sensors[msg.sensor].humidity.innerText = msg.humidity.toFixed(2);
            const chart = sensors[msg.sensor].chart;
            chart.data.labels.pop();
            chart.data.datasets.forEach((dataset) => {
                dataset.data.pop();
            });
            chart.data.labels.unshift(getTime(msg.time));
            chart.data.datasets[0].data.unshift(msg.temperature.toFixed(2));
            chart.data.datasets[1].data.unshift(msg.humidity.toFixed(2));
            chart.update();
        });
    }
</script>
</html>
